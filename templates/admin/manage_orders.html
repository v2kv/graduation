{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Manage Orders</h2>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Order ID</th>
                <th>User</th>
                <th>Status</th>
                <th>Total</th>
                <th>Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            <tr class="{% if 'failed' in order.order_status %}table-danger{% elif order.refund_requested %}table-warning{% endif %}">
                <td>{{ order.order_id }}</td>
                <td>{{ order.user.username }}</td>
                <td>{{ order.order_status|title }}</td>
                <td>${{ order.total_amount }}</td>
                <td>{{ order.order_date.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                            Actions
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#statusModal{{ order.order_id }}">Update Status</a></li>
                            {% if order.refund_requested %}
                            <li><a class="dropdown-item" href="{{ url_for('admin.process_refund', order_id=order.order_id) }}">Process Refund</a></li>
                            {% endif %}
                        </ul>
                    </div>
                    
                    <!-- Status Modal -->
                    <div class="modal fade" id="statusModal{{ order.order_id }}" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <form method="POST" action="{{ url_for('admin.update_order_status', order_id=order.order_id) }}">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Update Order Status</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <select name="status" class="form-select">
                                            <option value="payment_successful" {% if order.order_status == 'payment_successful' %}selected{% endif %}>Payment Successful</option>
                                            <option value="sent" {% if order.order_status == 'sent' %}selected{% endif %}>Sent</option>
                                            <option value="delivered" {% if order.order_status == 'delivered' %}selected{% endif %}>Delivered</option>
                                            <option value="cancelled" {% if order.order_status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                                        </select>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        <button type="submit" class="btn btn-primary">Save changes</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}