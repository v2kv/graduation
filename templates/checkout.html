{% extends 'layout.html' %}

{% block title %}Checkout{% endblock %}

{% block content %}
<h1>Checkout</h1>

<!-- Order Summary -->
<h3>Order Summary</h3>
{% if cart and cart.items %}
    <ul class="list-group mb-4">
        {% for item in cart.items %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                {{ item.item.item_name }} (x{{ item.quantity }})
                <span>${{ item.item.item_price * item.quantity }}</span>
            </li>
        {% endfor %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <strong>Total:</strong>
            <strong>${{ cart.items | sum(attribute='total_price') }}</strong>
        </li>
    </ul>
{% else %}
    <p>Your cart is empty.</p>
    <a href="{{ url_for('index.index') }}" class="btn btn-primary">Go Shopping</a>
{% endif %}

<!-- Shipping Address -->
<h3>Shipping Address</h3>
{% if addresses %}
    <form action="{{ url_for('order.checkout_process') }}" method="post">
        <div class="form-group">
            {% for address in addresses %}
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="address_id" id="address{{ address.address_id }}" value="{{ address.address_id }}" required>
                    <label class="form-check-label" for="address{{ address.address_id }}">
                        {{ address.address_line }}, {{ address.city }}, {{ address.country }}
                    </label>
                </div>
            {% endfor %}
        </div>
{% else %}
    <p>No saved addresses. <a href="{{ url_for('user.add_address') }}">Add one</a>.</p>
{% endif %}

<!-- Payment Method -->
<h3>Payment Method</h3>
{% if payment_methods %}
    <div class="form-group">
        {% for payment in payment_methods %}
            <div class="form-check">
                <input class="form-check-input" type="radio" name="payment_method_id" id="payment{{ payment.payment_id }}" value="{{ payment.payment_id }}" required>
                <label class="form-check-label" for="payment{{ payment.payment_id }}">
                    {{ payment.issuer }} ending in {{ payment.last_four_digits }}
                </label>
            </div>
        {% endfor %}
    </div>
{% else %}
    <p>No saved payment methods. <a href="{{ url_for('user.add_payment_method') }}">Add one</a>.</p>
{% endif %}

<!-- Submit Button -->
<button type="submit" class="btn btn-success w-100 mt-4">Pay with Stripe</button>
</form>
{% endblock %}