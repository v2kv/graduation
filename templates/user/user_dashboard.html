{% extends "layout.html" %} {% block title %}User Dashboard{% endblock %} {%
block link %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='user_dashboard.css') }}"
/>
{% endblock %} {% block content %}
<div class="container mt-4 main-c">
  <!-- <h1>Welcome, {{ user.username }}!</h1>
  <hr /> -->

  <h4 class="">My account |<i class="fa-solid fa-house iconsss"></i></h4>
  <div class="items">
    <div class="row">
      <div class="col">
        <button
          class="load-content"
          data-url="{{ url_for('user.user_profile') }}"
        >
          <div class="row">
            <div class="col-2"><i class="fa-solid fa-user"> </i></div>
            <div class="col">Profile</div>
          </div>
        </button>
      </div>
      <div class="col">
        <button
          class="load-content"
          data-url="{{ url_for('user.change_password') }}"
        >
          <div class="row">
            <div class="col-2"><i class="fa-solid fa-lock"> </i></div>
            <div class="col">Password</div>
          </div>
        </button>
      </div>
      <div class="col">
        <button
          class="load-content"
          data-url="{{ url_for('user.add_address') }}"
        >
          <div class="row">
            <div class="col-2"><i class="fa-solid fa-location-dot"> </i></div>
            <div class="col">Address</div>
          </div>
        </button>
      </div>
      <div class="col">
        <button
          class="load-content"
          data-url="{{ url_for('order.view_orders') }}"
        >
          <div class="row">
            <div class="col-2"><i class="fa-solid fa-user"> </i></div>
            <div class="col">Orders</div>
          </div>
        </button>
      </div>
      <div class="col">
        <button
          class="load-content"
          data-url="{{ url_for('user.user_messages') }}"
        >
          <div class="row">
            <div class="col-2"><i class="fa-solid fa-envelope"> </i></div>
            <div class="col">Messages</div>
          </div>
        </button>
      </div>
      <div class="col">
        <button
          class="load-content"
          data-url="{{ url_for('user.user_payments') }}"
        >
          <div class="row">
            <div class="col-2"><i class="fa-solid fa-money-bill"> </i></div>
            <div class="col">Payment</div>
          </div>
        </button>
      </div>
    </div>
  </div>

  <div class="dynamic-page"></div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>

$(document).ready(function() {
  console.log("Dashboard initialized");

  $(".load-content").click(function() {
    let pageUrl = $(this).data("url");
    console.log("Loading content from:", pageUrl);
    
    $(".dynamic-page").html("<p class='text-center'><i class='fa fa-spinner fa-spin'></i> Loading...</p>");
    
    $.ajax({
      url: pageUrl,
      type: "GET",
      cache: false,
      success: function(response) {
        console.log("Content loaded successfully");

        $(".dynamic-page").html(response);
        
        if (pageUrl.includes("payments") || pageUrl.includes("user_payments")) {
          console.log("Payments page detected");

          let paymentMethodsList = $(".dynamic-page").find("#payment-methods-list");

          if ($("#add-payment-method-btn").length === 0) {
            console.log("Button not found - adding it");

            if (paymentMethodsList.length > 0) {
              paymentMethodsList.before('<button id="add-payment-method-btn" class="btn btn-primary mb-4">Add Payment Method</button>');
              paymentMethodsList.before('<div id="add-payment-form-container" style="display: none;"></div>');

              $(".dynamic-page").prepend('<button id="add-payment-method-btn" class="btn btn-primary mb-4">Add Payment Method</button>');
              $(".dynamic-page").prepend('<div id="add-payment-form-container" style="display: none;"></div>');
            }
          }

          $("#add-payment-method-btn").off("click").on("click", function() {
            console.log("Add payment button clicked");

            $("#add-payment-form-container").html('<div class="text-center p-3"><i class="fa fa-spinner fa-spin"></i> Loading payment form...</div>').show();
            

            $(this).prop('disabled', true);
            
            $.ajax({
              url: "/user/payments/add", 
              type: "GET",
              headers: {'X-Requested-With': 'XMLHttpRequest'},
              success: function(response) {
                console.log("Payment form loaded successfully");
                $("#add-payment-form-container").html(response);
                
              },
              error: function(xhr, status, error) {
                console.error("Error loading payment form:", error);
                $("#add-payment-form-container").html(
                  '<div class="alert alert-danger">Error loading payment form. Please try again.</div>'
                );
                
                $("#add-payment-method-btn").prop('disabled', false);
                
                setTimeout(function() {
                  $("#add-payment-form-container").slideUp(function() {
                    $(this).empty();
                  });
                }, 3000);
              }
            });
          });

          attachPaymentMethodHandlers();
        }
      },
      error: function(xhr, status, error) {
        console.error("Error loading content:", error);
        $(".dynamic-page").html(`
          <div class="alert alert-danger">
            <p>Error loading content: ${status}</p>
            <button class="btn btn-primary" onclick="window.location.reload()">Refresh</button>
          </div>
        `);
      }
    });
  });
  
  function attachPaymentMethodHandlers() {
    $(".set-default-form").off("submit").on("submit", function(e) {
      e.preventDefault();
      const url = $(this).attr("action");
      
      $.ajax({
        url: url,
        type: "POST",
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        success: function(response) {
          if (response.success) {
            alert(response.message);
            location.reload();
          } else {
            alert(response.message || "Error setting default payment method");
          }
        },
        error: function() {
          alert("Error setting default payment method");
        }
      });
    });
    
    $(".delete-payment-form").off("submit").on("submit", function(e) {
      e.preventDefault();
      if (confirm("Are you sure you want to delete this payment method?")) {
        const url = $(this).attr("action");
        
        $.ajax({
          url: url,
          type: "POST",
          headers: {'X-Requested-With': 'XMLHttpRequest'},
          success: function(response) {
            if (response.success) {
              alert(response.message);
              location.reload();
            } else {
              alert(response.message || "Error deleting payment method");
            }
          },
          error: function() {
            alert("Error deleting payment method");
          }
        });
      }
    });
  }
});
</script>

{% endblock %}
